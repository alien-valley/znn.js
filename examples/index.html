<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="../build/bundle.js"></script>

<input type="password" id="password" value=""/><br/>
<input type="file" id="selectFiles" value="Import"/><br/>
<button id="import">Import</button>

<div id="messages"></div>

<script>
    request = async function (method, params, callback) {
        return $.ajax({
            type: 'POST',
            // alien-valley node
            url: 'http://139.177.178.226:35997',
            crossDomain: true,
            data: JSON.stringify({"jsonrpc": "2.0", "id": 0, "method": method, "params": params}),
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.setRequestHeader("Accept", "application/json, text/plain, */*");
            }, success: callback
        });
    }

    document.getElementById('import').onclick = async function () {
        var files = document.getElementById('selectFiles').files;
        if (files.length <= 0) {
            return false;
        }

        var fr = new FileReader();
        fr.onload = async function (e) {
            var result = JSON.parse(e.target.result);
            var password = document.getElementById('password').value;
            var messages = document.getElementById('messages');

            messages.innerText = "decrypting ...";

            let entropy;
            try {
                entropy = await znn.KeyFile.Decrypt(result, password);
            } catch (e) {
                if (e.toString() === "Error: Unsupported state or unable to authenticate data") {
                    messages.innerText = `failed to decrypt: invalid password`;
                } else {
                    messages.innerText = `failed to decrypt ${e}`;
                }
                return;
            }

            const keyPair = znn.KeyPair.FromEntropy(entropy);
            const address = keyPair.address();

            messages.innerText = `address is ${address.toString()}\n`;

            request("ledger.getAccountInfoByAddress", [address.toString()], (data) => {
                messages.innerText += "Balance is\n"
                for (const zts in data.result.balanceInfoMap) {
                    const value = data.result.balanceInfoMap[zts];
                    messages.innerText += `${value.balance / Math.pow(10, value.token.decimals)} ${value.token.name}\n`;
                }
            });
        }
        fr.readAsText(files.item(0));
    };
</script>